class InfiniteScrollManager{constructor(e){this.settings=Object.assign({container:"#scrollContainer",paginationPrevious:"#scrollPaginationPrevious",paginationNext:"#scrollPaginationNext",threshold:0,enableHtml5History:!0,pageQueryParamName:"page",margin:.3,debug:!1,pageTitle:"Page {pageNum}"},e||{}),this.currentPage=1,this.minPageLoaded=Number.MAX_VALUE,this.initialize()}initialize(){var e=new URL(window.location).searchParams;this.currentPage=e.has(this.settings.pageQueryParamName)?e.get(this.settings.pageQueryParamName):this.currentPage,this.containerElement=document.querySelector(this.settings.container),this.paginationNextElement=document.querySelector(this.settings.paginationNext),this.paginationPreviousElement=document.querySelector(this.settings.paginationPrevious),this.containerElement&&(this.initializePageLoadObserver(),this.initializePageChangeObserver(),this.currentPage=e.has(this.settings.pageQueryParamName)?e.get(this.settings.pageQueryParamName):this.currentPage,1!=this.currentPage)&&this.containerElement.scrollIntoView()}initializePageLoadObserver(){var e=this.containerElement.clientHeight*this.settings.margin;this.intersectionObserver=new IntersectionObserver(this.onIntersection.bind(this),{threshold:this.settings.threshold,rootMargin:e+`px 0px ${e}px 0px`}),this.paginationPreviousElement&&this.intersectionObserver.observe(this.paginationPreviousElement),this.paginationNextElement&&this.intersectionObserver.observe(this.paginationNextElement)}initializePageChangeObserver(){this.pageChangeObserver=new IntersectionObserver(this.onPageChange.bind(this)),this.containerElement.prepend(this.createPageDivision(this.currentPage)),this.pageChangeObserver.observe(document.querySelector(`[data-page="${this.currentPage}"]`))}destroy(e){e.dispatchEvent(new CustomEvent("infinitescroll:end")),e.innerHTML=""}onPageChange(e){e.forEach(e=>{e.isIntersecting&&(this.currentPage=parseInt(e.target.dataset.page),this.pushHtml5History())})}onIntersection(e){e.forEach(e=>{e.isIntersecting&&this.loadMore(e.target)})}loadMore(e){this.debug("loadMore - "+this.currentPage);var t,i=e.querySelector("a");i?((t=new XMLHttpRequest).open("GET",i.href,!1),t.send(),i=(new DOMParser).parseFromString(t.responseText,"text/html"),e==this.paginationPreviousElement?this.onHttpRequestLoadPrevious(t,i):this.onHttpRequestLoadNext(t,i)):this.destroy(e)}onHttpRequestLoadPrevious(e,t){const i=window.scrollY;if(this.debug("onHttpRequestLoadPrevious - "+this.currentPage),e.responseText&&4!==!e.readyState&&200!==!e.status){const n=t.querySelector(this.settings.container).firstElementChild;e=t.querySelector(this.settings.paginationPrevious);this.currentPage--,this.minPageLoaded=Math.min(this.currentPage,this.minPageLoaded-1),this.containerElement.prepend(n),setTimeout(()=>{var e=n.scrollHeight+window.innerHeight/2;window.scrollY<e&&window.scrollTo(0,i+n.scrollHeight)},100),this.containerElement.prepend(this.createPageDivision(this.minPageLoaded)),this.pageChangeObserver.observe(document.querySelector(`[data-page="${this.minPageLoaded}"]`)),e?(this.paginationPreviousElement.innerHTML=e.innerHTML,this.triggerLoadEvent(n)):this.destroy(this.paginationPreviousElement)}}onHttpRequestLoadNext(e,t){this.debug("onHttpRequestLoadNext - "+this.currentPage),e.responseText&&4!==!e.readyState&&200!==!e.status&&(this.currentPage++,e=t.querySelector(this.settings.container),t=t.querySelector(this.settings.paginationNext),e.prepend(this.createPageDivision(this.currentPage)),this.containerElement.insertAdjacentHTML("beforeend",e.innerHTML),this.pageChangeObserver.observe(document.querySelector(`[data-page="${this.currentPage}"]`)),t?(this.paginationNextElement.innerHTML=t.innerHTML,this.triggerLoadEvent(e)):this.destroy(this.paginationNextElement))}pushHtml5History(){var e;window.history.state?.page&&window.history.state.page==this.currentPage||(this.debug("pushHtml5History - "+this.currentPage),this.settings.enableHtml5History&&((e=new URL(window.location)).searchParams.set(this.settings.pageQueryParamName,this.currentPage),window.history.pushState({page:this.currentPage},"",e)))}createPageDivision(e){this.debug("createPageDivision - "+e);var t=document.createElement("div");return t.dataset.page=e,t.innerText=this.settings.pageTitle.replace("{pageNum}",e),t.classList.add("page-divider"),t.style.visibility="hidden",t}triggerLoadEvent(e){document.dispatchEvent(new CustomEvent("infinitescroll:load",{detail:{content:e}}))}addLoadEventListener(e){document.addEventListener("infinitescroll:load",e)}addPreviousPageScrollEndEventListener(e){this.paginationPreviousElement.addEventListener("infinitescroll:end",e)}addNextPageScrollEndEventListener(e){this.paginationNextElement.addEventListener("infinitescroll:end",e)}debug(e){this.settings.debug&&console.log(e)}}export{InfiniteScrollManager,InfiniteScrollManager as default};